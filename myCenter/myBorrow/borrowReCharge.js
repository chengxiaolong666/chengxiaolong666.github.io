var base={};base.lPrincipal=0;base.lMaxRepayAmount=0;base.lInterest=0;base.lOverdueAmount=0;base.strBeforeBillDate="";base.strBorrowerMonthRate=0;base.lId="";base.totalAmount=0;base.oldAmount=0;base.end_fj=0;base.nInterestRepayed=0;base.serviceDate="";base.strBorrowEndDate="";base.lUserId="";base.url="";base.strBorrowerMonthRate=0;base.strAmount=0;base.strCreateTime="";base.strVersionType="";base.nHaier=getQueryString("nHaier");base.strAuthorizeNum=getQueryString("strAuthorizeNum");base.strConsultNo=getQueryString("strConsultNo");base.strContractNo=getQueryString("strContractNo");base.payTypeBorrow=getQueryString("payTypeBorrow");base.lBorrowBillId=getQueryString("lBorrowBillId");base.nFundSource=99;base.lAccountBalance=0;jsHeight.bodyheight();if(base.lBorrowBillId!=null){base.payType=1;var lInterest=getQueryString("lInterest");var lOverdueAmount=getQueryString("lOverdueAmount");var money=getQueryString("money");var cMoney=money*100-lInterest*100-lOverdueAmount*100;if(cMoney>0){cMoney=parseFloat((Number(cMoney)/100).toFixed(2));$("#daihuanbenjin1").html(cMoney+"元");$("#daihuanbenjin").show()}$("#daihuanjine").hide();$("#showinfo3").show();$("#borrowhr_account").hide();$("#user_totalAmount").hide();$("#user_lx").html(lInterest+"元");$("#user_fj").html(lOverdueAmount+"元");$("#user_je").html(money)}if(base.nHaier==1){$("#showinfo2").show()}else{$("#showinfo1").show()}window.onload=function(){_shade_layer.show("努力加载中,请稍候...");if(base.nHaier=="1"){$("#user_principal").attr("readonly","readonly")}base.lId=getQueryString("lId");base.lUserId=getStringValue("lUserId");base.strBorrowerMonthRate=getQueryString("strBorrowerMonthRate");base.url=getQueryString("url");base.strAmount=getQueryString("strAmount");base.strCreateTime=getQueryString("strCreateTime");base.strVersionType=getQueryString("strVersionType");base.strConsultNo=getQueryString("strConsultNo");base.strContractNo=getQueryString("strContractNo");setBackURL(base.url,"我的还款","payTypeBorrow="+base.payTypeBorrow+"&strContractNo="+base.strContractNo+"&strConsultNo="+base.strConsultNo+"&strAuthorizeNum="+base.strAuthorizeNum+"&nHaier="+base.nHaier+"&lId="+base.lId+"&strBorrowerMonthRate="+base.strBorrowerMonthRate+"&strVersionType="+base.strVersionType+"&strAmount="+base.strAmount+"&strCreateTime="+base.strCreateTime,1,"");queryRemaining();queryBank();if(base.lBorrowBillId!=null){}else{getBorrowBaseParams(base.lId,base.nHaier)}};function queryRemaining(){var a=new CDO();a.setStringValue("strServiceName","AccountUserBIQueryService");a.setStringValue("strTransName","getAccountAmount");a.setLongValue("lUserId",Number(base.lUserId));raiseTrans(a,"callBackRemaining")}function callBackRemaining(d,e,a){if(a==null||a==undefined){info("查询余额，网络异常");return false}if(a.nCode==0&&e.exists("cdoAccountAmount")){var c=e.getCDOValue("cdoAccountAmount");var b=c.getStringValue("lAvailablebalance1");b=(Number(b)/100);$("#draw_balance_id").html("余额"+b+"元");base.lAccountBalance=b}else{info(a.strText)}}var queryBank=function(){var a=new CDO();a.setStringValue("strServiceName","BorrowerService");a.setStringValue("strTransName","getBankBaseInfo");a.setLongValue("lUserId",Number(base.lUserId));raiseTrans(a,"callBackQueryBank")};function callBackQueryBank(c,e,b){if(b==null||b==undefined){info("查询银行卡信息，网络异常");return false}if(b.nCode==0&&e.exists("cdoBank")){var a=e.getCDOValue("cdoBank");var d=a.getStringValue("nProtocolState");base.strBankCode=a.getStringValue("strBankCode");queryBankLimit(base.strBankCode,d)}else{info(b.strText)}}var queryBankLimit=function(b,c){var a=new CDO();a.setStringValue("strServiceName","CommonService");a.setStringValue("strTransName","getThirdBankLimit");a.setLongValue("strCode",b);a.setIntegerValue("nProtocolState",c);raiseTrans(a,"callBackBankWithholdLimit")};function callBackBankWithholdLimit(b,e,a){if(a==null||a==undefined){info("查询银行卡限额,网络异常");return false}if(a.nCode==0){var f=e.getStringValue("strDKValue");var j=e.getLongValue("lDKValue");var i=e.getStringValue("strKJValue");var g=e.getLongValue("lKJValue");var h=b.getIntegerValue("nProtocolState");if(j==0){$("#draw_bank_id").html("该卡本次支付无限额")}else{$("#draw_bank_id").html("该卡本次最多可支付"+fmoney(j,2))}if(g==0){$("#draw_other_id").html("该卡本次支付无限额")}else{$("#draw_other_id").html("该卡本次最多可支付"+fmoney(g,2))}var c=e.getStringValue("DKEnable");var d=e.getStringValue("QPEnable");showBankInfo(c,d)}}function getBorrowBaseParams(d,c){var b=new CDO();var a=getStringValue("lUserId");b.setStringValue("strServiceName","BorrowerRepaymentService");b.setStringValue("strTransName","getMobilePrePaymentAmount");b.setLongValue("lBorrowerId",Number(a));b.setLongValue("lBorrowIntentId",d);b.setLongValue("nHaier",c);raiseTrans(b,"callBackForGetBorrowBaseParams")}function callBackForGetBorrowBaseParams(d,f,b){base.lId=getQueryString("lId");base.nHaier=getQueryString("nHaier");if(b==undefined||b==null){_shade_layer.hide();$("#container").show();return}try{if(b.nCode==0){$("#yhfwf").html(f.getStringValue("lInterest"));$("#yhlx").html(f.getStringValue("lHaierInterest"));$("#fwfwyj").html(f.getStringValue("lOverdueInterest"));$("#bjyqfx").html(f.getStringValue("lHaierOverdueAmount"));$("#yqglf").html(f.getStringValue("lOverdueAmount"));var a=f.getStringValue("lSumAmount");$("#hkzje").html('<B id="hkzje1">'+a+"</B>元");base.lPrincipal=f.getStringValue("lPrincipal");base.lMaxRepayAmount=f.getStringValue("lMaxRepayAmount");base.lInterest=f.getStringValue("lInterest");base.lOverdueAmount=f.getStringValue("lOverdueAmount");base.strBeforeBillDate=f.getStringValue("strBeforeBillDate");base.nInterestRepayed=f.getStringValue("nInterestRepayed");base.serviceDate=f.getStringValue("dtNow");base.strBorrowEndDate=f.exists("strBorrowEndDate")?f.getStringValue("strBorrowEndDate"):"";base.lMaxRepayAmount=base.lMaxRepayAmount/100;base.lInterest=base.lInterest;base.lOverdueAmount=base.lOverdueAmount}}catch(c){_shade_layer.hide()}base.lPrincipal=base.lMaxRepayAmount;$("#user_principal").val(base.lPrincipal);repaymentCalculator(base)}function repaymentCalculator(b){if(b.lPrincipal*100>b.lMaxRepayAmount*100){$("#user_principal").val(b.oldAmount);info("您输入的本金已经超出最大可还本金金额,最大可还金额："+b.lMaxRepayAmount);return}var j=0;var i=twoDateSize(b.strBeforeBillDate,b.serviceDate);if(i){j=getDays(b.strBeforeBillDate,b.serviceDate);if(j==0||b.nInterestRepayed==2){j+=1}if(b.nInterestRepayed==1){j=0}}var d=(b.lInterest/100+(b.lPrincipal*j*b.strBorrowerMonthRate/100)/30).toFixed(2);if(b.strBorrowEndDate==""){b.strBorrowEndDate=new Date().Format("yyyy-MM-dd")}var g=twoDateSize(b.strBorrowEndDate,b.serviceDate);if(g){var a=getDays(b.strBorrowEndDate,b.serviceDate);var e=(b.lPrincipal*0.005*a).toFixed(2);b.end_fj=Number(e*100)+Number(b.lOverdueAmount)}else{b.end_fj=Number(b.lOverdueAmount)}$("#user_lx").html(d+"元");$("#user_fj").html((Number(b.end_fj)/100).toFixed(2)+"元");var c=Number(b.lPrincipal)*100;var h=Number(d)*100;var f=Number(b.end_fj);b.totalAmount=((c+h+f)/100).toFixed(2);$("#user_totalAmount").html('<B id="user_totalAmount1">'+b.totalAmount+"</B>元");b.oldAmount=b.lPrincipal}var flag=true;function repay(){if(flag){var c=99;$(".correctmanual_svg").each(function(d){if($(this).css("display")!="none"){c=$(this).attr("dataValue");return false}});if(c==99){info("暂无支付通道，请联系客户经理");return false}var b=getQueryString("money");if(b==null){b=$.trim($("#user_totalAmount1").html())}if(c==1&&b>base.lAccountBalance){_TTPopups.open2({content:"您的账户余额不足，请充值",cancelBtn:"取消",submitBtn:"确定",closeCallBack:"callBackOpen"});return false}base.nFundSource=c;if(base.lBorrowBillId!=null){checkIsPayPwd("open_paybtn1")}else{var a=$("#user_principal").val();if(a!=null&&a!=undefined&&!isNaN(a)){if(a*100>base.lMaxRepayAmount*100){info("您输入的本金已经超出最大可还本金金额,最大可还金额："+base.lMaxRepayAmount)}else{if(Number(a)%100!=0){info("本金必须是100的整数倍!")}else{if(Number(a)<=0){info("请您输入大于0元的本金金额!")}else{checkIsPayPwd("open_paybtn")}}}}else{info("请输入正确金额")}}}}function callBackOpen(a){if(a==1){setStringValue("backURL","myBorrow");openWindow("myCenter/recharge/financial_recharge.htm","充值页面","",0)}}function open_paybtn(){var a="输入支付密码";if(base.nHaier==1){lMoney=Number($("#hkzje1").html())}else{lMoney=base.totalAmount}if(Number(lMoney)<=0){info("支付金额必须大于0元");return}var c=false;var b="callbackFunctionRepayBorrow";openPayWindow(a,"交易金额："+lMoney+"元","","",c,b)}function open_paybtn1(){var a="输入支付密码";var c=getQueryString("money");if(Number(c)<=0){info("支付金额必须大于0元");return}var b=false;openPayWindow(a,"交易金额："+c+"元","","",b,"callbackFunctionRepayBorrow1")}function callbackFunctionRepayBorrow1(b,a){b=hex_md5(b);if(a==1){repayBorrowBill(b)}}function repayBorrowBill(b){var c=getQueryString("lId");var a=new CDO();a.setStringValue("strServiceName","BorrowerRepaymentService");a.setStringValue("strTransName","doRepaymentBill");a.setIntegerValue("nFundSource",base.nFundSource);a.setLongValue("lBorrowerId",base.lUserId);a.setLongValue("lId",base.lBorrowBillId);a.setLongValue("lBorrowIntentId",c);a.setStringValue("strPayPassword",b);raiseTrans(a,"callBackBuy")}function callBackBuy(c,d,a){if(a==null||typeof a=="undefined"){info("网络异常");return false}if(a.nCode==0){var b=getQueryString("money");openWindow("myCenter/myBorrow/repaymentSuccess.htm","我的借款","lAmount="+b,0)}else{info(a.strText)}}function callbackFunctionRepayBorrow(b,a){b=hex_md5(b);if(a==1){var c=new CDO();c.setStringValue("strServiceName","CustomerService");c.setStringValue("strTransName","verifyPayPassword");c.setLongValue("lUserId",base.lUserId);c.setStringValue("strPayPassword",b);raiseTrans(c,"callBackValidatePass")}}function callBackValidatePass(f,g,a){var d=f.getStringValue("strPayPassword");if(a==null||a.getCode()!=0){if(a!=null&&a.getCode()==1){payPwdPutError(a.strText);return}info(a.strText);return false}else{var e=new CDO();var b=getStringValue("lUserId");e.setStringValue("strServiceName","CommonService");e.setStringValue("strTransName","doMobilePrePayment");e.setLongValue("lBorrowerId",Number(b));e.setLongValue("lBorrowIntentId",base.lId);e.setStringValue("strPayPassword",d);var c=$("#user_principal").val();e.setLongValue("lAmount",c*100);e.setStringValue("strVersionType",base.strVersionType);e.setIntegerValue("nFundSource",base.nFundSource);flag=false;raiseTrans(e,"callBackForRepay")}}function callBackForRepay(b,c,a){flag=true;if(a==undefined||a==null){info("请求失败!");return false}if(a.nCode==0){setTimeout(function(){var d=0;if(base.nHaier==1){d=$.trim($("#hkzje1").html())}else{d=$.trim($("#user_totalAmount1").html())}openWindow("myCenter/myBorrow/repaymentSuccess.htm","我的借款","lAmount="+d,0)},300)}else{info(a.strText)}}var openWin=function(){var a="payTypeBorrow="+base.payTypeBorrow+"&strContractNo="+base.strContractNo+"&strConsultNo="+base.strConsultNo+"&strAuthorizeNum="+base.strAuthorizeNum+"&nHaier="+base.nHaier+"&lId="+base.lId+"&strBorrowerMonthRate="+base.strBorrowerMonthRate+"&strAmount="+base.strAmount+"&strCreateTime="+base.strCreateTime+"&strVersionType="+base.strVersionType;openDelayWindow(base.url,"我的借款",a,1,"",1)};$("#user_principal").bind("input propertychange",function(){var a=$("#user_principal").val();if(isNaN(a)){$("#user_lx").html("");$("#user_fj").html("");$("#user_totalAmount").html("");base.totalAmount=0}else{base.lPrincipal=a;repaymentCalculator(base)}});function showBankInfo(a,f){var e=base.payTypeBorrow.split(",");var d=e[0];var c=e[1];var b=e[2];if(d==1&&f==1){$("#kjDiv").show()}if(b==1&&a==1){$("#dkDiv").show()}if(c==1){$("#yueDiv").show()}$(".changeDiv").each(function(){if($(this).css("display")!="none"){$(this).find(".correctmanual_svg").show();return false}});$("#hidDiv").show();_shade_layer.hide()}$(".changeDiv").click(function(){if($(this).find(".correctmanual_svg").css("display")!="none"){return false}$(".correctmanual_svg").each(function(){$(this).hide()});$(this).find(".correctmanual_svg").show()});