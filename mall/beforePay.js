var goodsObj={};var usrObj={};usrObj.strPwd="";var orderObj={};orderObj.lAddressId="";orderObj.strOrderSerl="";jsHeight.bodyheight();var loadOrderInfo=function(){goodsObj.strGoodsTitle=getStringValue("strGoodsTitle");goodsObj.strGoodsAmount=getStringValue("strGoodsAmount");goodsObj.strAmount=getStringValue("strAmount");goodsObj.strFirstPrice=getStringValue("strFirstPrice");goodsObj.strTermCount=getStringValue("strTermCount");goodsObj.strGoodsId=getStringValue("strGoodsId");goodsObj.strGoodsSKUId=getStringValue("strGoodsSKUId");goodsObj.strTermPrice=getStringValue("strTermPrice");goodsObj.strGoodsURL=getStringValue("strGoodsURL");$("#strGoodsTitle").html(goodsObj.strGoodsTitle);$("#strGoodsAmount").html(goodsObj.strGoodsAmount);$("#strAmount").html("￥"+(Number(goodsObj.strAmount)/100));$("#strFirstPrice").html("￥"+(Number(goodsObj.strFirstPrice)/100));$("#strTermCount").html(goodsObj.strTermCount+"期");$("#strTermPrice").html("￥"+(Number(goodsObj.strTermPrice)/100));$("#strRealPay").html((Number(goodsObj.strFirstPrice)/100)+"  元");$("#strGoodsURL").attr("src",goodsObj.strGoodsURL)};var loadUserInfo=function(){usrObj.lBuyerId=getStringValue("lUserId");usrObj.strBuyerLoginId=getStringValue("strMobile");usrObj.strName=getStringValue("strName");usrObj.strSelectAddressId=getStringValue("strSelectAddressId")};$(function(){_shade_layer.show("加载中,请稍候...");loadOrderInfo();loadUserInfo();if(usrObj.strSelectAddressId==undefined||usrObj.strSelectAddressId==null||usrObj.strSelectAddressId==""){getDefaultAddressByBuyerId()}else{getAddressByAId()}setTimeout(function(){$("#toSelectGoods").click(function(){clearCache();setStringValue("lGoodsId",goodsObj.strGoodsId);openWindow("mall/goodsDetail.htm","商品详情","",1)});$("#noAddressSelected").click(function(){setStringValue("fromBeforePay","1");openDelayWindow("mall/addressAdd.htm","添加地址","",0)});$("#toAddressListOrAdd").click(function(){clearCache();if(orderObj.lAddressId==undefined||orderObj.lAddressId==null||orderObj.lAddressId==""){setStringValue("fromBeforePay","1");openDelayWindow("mall/addressAdd.htm","添加地址","",0);return false}else{if(document.getElementById("mui-content")!=undefined){document.getElementById("mui-content").style.display="none"}openDelayWindow("mall/addressList.htm","地址列表","",0);return false}});$("#toOrderList").click(function(){openDelayWindow("myCenter/mallOrder/orderList.htm","订单列表","backType=beforePay",0)});$("#toBeforePage").click(function(){clearCache();openWindow("mall/stages.htm","商品分期","",1)});$("#doPay").click(function(){doPay()})},300)});function getDefaultAddressByBuyerId(){var a=new CDO();a.setStringValue("strServiceName","AddressService");a.setStringValue("strTransName","getDefaultAddressByBuyerId");a.setLongValue("lBuyerId",Number(usrObj.lBuyerId));raiseTrans(a,"callBackForGDA")}function callBackForGDA(e,g,a){if(a==undefined||a==null||a.nCode!=0){document.getElementById("containerShow").style.display="block";_shade_layer.hide();return false}if(g.exists("cdoDefaultAddress")){var h=g.getCDOValue("cdoDefaultAddress");if(!h.exists("lId")||!h.exists("lBuyerId")||!h.exists("strConsigneeName")||!h.exists("strMobile")||!h.exists("strFullDistrictName")||!h.exists("strAddress")){_shade_layer.hide();info("获取默认地址失败");return false}orderObj.lAddressId=h.getLongValue("lId");var c=h.getLongValue("strConsigneeName");var b=h.getLongValue("strMobile");var d=h.getLongValue("strFullDistrictName").replace("|","").replace("|","");var f=h.getLongValue("strAddress");$("#strConsigneeName").html(c);$("#strMobile").html(b);$("#strFullAdress").html(d+" "+f)}checkAddressId();document.getElementById("containerShow").style.display="block";_shade_layer.hide()}function getAddressByAId(){var a=new CDO();a.setStringValue("strServiceName","AddressService");a.setStringValue("strTransName","getAddressByAId");a.setLongValue("lAddressId",usrObj.strSelectAddressId);raiseTrans(a,"callBackForGABID")}function callBackForGABID(f,h,a){if(a==undefined||a==null||a.nCode!==0){document.getElementById("containerShow").style.display="block";_shade_layer.hide();info("获取用户选中的地址信息失败!");return false}if(h.exists("cdoAddress")){var b=h.getCDOValue("cdoAddress");if(!b.exists("lId")||!b.exists("lBuyerId")||!b.exists("strConsigneeName")||!b.exists("strMobile")||!b.exists("strFullDistrictName")||!b.exists("strAddress")){_shade_layer.hide();info("获取用户选中的地址信息失败：");return false}orderObj.lAddressId=b.getLongValue("lId");var d=b.getLongValue("strConsigneeName");var c=b.getLongValue("strMobile");var e=b.getLongValue("strFullDistrictName").replace("|","").replace("|","");var g=b.getLongValue("strAddress");$("#strConsigneeName").html(d);$("#strMobile").html(c);$("#strFullAdress").html(e+" "+g)}checkAddressId();document.getElementById("containerShow").style.display="block";_shade_layer.hide()}function checkAddressId(){if(orderObj.lAddressId==undefined||orderObj.lAddressId==null||orderObj.lAddressId==""){$("#noAddressSelected").show();$("#toAddressListOrAdd").hide()}else{$("#toAddressListOrAdd").show();$("#noAddressSelected").hide()}}function clearCache(){clearArray(["strSelectAddressId"])}var isDisposeing=0;function doPay(){if(isDisposeing==1){return false}isDisposeing=1;var a=goodsObj.strFirstPrice;setStringValue("strFirstMoney",a);if(orderObj.strOrderSerl!==""){openPayWindow("请输入支付密码","交易金额："+(Number(goodsObj.strFirstPrice)/100)+" 元","","",true,"callBackForIntoPass")}else{_credit.proj="1";isDisposeing=0;_credit.lUserId=usrObj.lBuyerId;verifyRealNameIde()}}function addOrder(){if(orderObj.lAddressId==undefined||orderObj.lAddressId==null||orderObj.lAddressId==""){isDisposeing=0;info("收货地址还没有填写，请添加");return false}try{if(Number(goodsObj.strAmount)<1||Number(goodsObj.strFirstPrice)<1||Number(goodsObj.strTermPrice)<1){isDisposeing=0;info("请求参数有误，请重新下单！");return false}}catch(b){isDisposeing=0;info("请求参数有误，请重新下单！");return false}var a=new CDO();a.setStringValue("strServiceName","OrderService");a.setStringValue("strTransName","addOrder");a.setStringValue("nAmount",""+goodsObj.strAmount);a.setStringValue("nGoodsAmount",""+goodsObj.strGoodsAmount);a.setStringValue("lBuyerId",""+usrObj.lBuyerId);a.setStringValue("strBuyerLoginId",""+usrObj.strBuyerLoginId);a.setStringValue("strBuyerName",""+usrObj.strName);a.setStringValue("lAddressId",""+orderObj.lAddressId);a.setStringValue("lGoodsSKUId",""+goodsObj.strGoodsSKUId);a.setStringValue("lGoodsId",""+goodsObj.strGoodsId);a.setStringValue("nFirstPrice",""+goodsObj.strFirstPrice);a.setStringValue("nProfit","0");a.setStringValue("nTermCount",""+goodsObj.strTermCount);a.setStringValue("nTermPrice",""+goodsObj.strTermPrice);a.setStringValue("strBuyerMessage","");a.setStringValue("strBuyerMemo","");raiseTrans(a,"callBackForAO")}function callBackForAO(e,f,b){if(b==undefined||b==null){isDisposeing=0;info("添加订单失败,服务器异常!");return false}if(b.nCode!=0||!f.exists("strOrderSerl")){isDisposeing=0;info(b.getText());return false}var d=f.getStringValue("strOrderSerl");var c=f.getStringValue("strOrderTime");var a=f.getStringValue("lOrderId");openWindow("mall/mallPay.htm","收银台页面","strOrderSerl="+d+"&strOrderTime="+c+"&lOrderId="+a,0)}function verifyRealNameIde(){var a=new CDO();a.setStringValue("strServiceName","CommonService");a.setStringValue("strTransName","queryIdentityOrPayPwd");a.setLongValue("lUserId",Number(usrObj.lBuyerId));raiseTrans(a,"callBackRealNameIde")}function callBackRealNameIde(d,f,a){if(a==null||typeof a=="undefined"){info("查询用户余额请求异常！");return}if(a.nCode!=0){info(a.strText);return}if(a.nCode==0&&f.exists("nIdentityState")){var c=f.getIntegerValue("nIdentityState");var e=f.exists("nProtocolState")?f.getIntegerValue("nProtocolState"):10;if(c==90||c==100){var b=f.getIntegerValue("nIsSetPayPwd");if(b==0){setPayPwd()}else{if(b==1){if(e==90||e==100||e==20){_credit.phoneAuthenState();return}goProtocolPage(e)}}}else{goIdenPage(c)}}}function goIdenPage(a){if(a==10){_TTPopups.open2({content:"您未实名认证，请认证",cancelBtn:"否",submitBtn:"是",closeCallBack:"TT_pay_sm_1"})}else{if(a==20){info("您的实名认证正在认证中，请稍候查看实名认证")}else{if(a==30){_TTPopups.open2({content:"您的实名认证失败,查看原因",cancelBtn:"否",submitBtn:"是",closeCallBack:"TT_pay_sm_2"})}}}}function TT_pay_sm_1(a){if(a==1){setTimeout(function(){openWindow("myCenter/securityCenter/accountIdCard.htm","实名认证","clearUser=1&nIdentityState=10",0)},300)}}function TT_pay_sm_2(a){if(a==1){setTimeout(function(){openWindow("myCenter/securityCenter/accountIdCard.htm","实名认证","clearUser=1&nIdentityState=30",0)},300)}}function setPayPwd(){_TTPopups.open2({content:"您没有设置支付密码,去设置",cancelBtn:"取消",submitBtn:"确定",closeCallBack:"callBackOpenPay"})}function callBackOpenPay(a){if(a==1){openWindow("myCenter/securityCenter/payPwdSet.htm","设置支付密码","",0)}}function goProtocolPage(a){if(a==10){_TTPopups.open2({content:"投资前需要签约代扣协议",cancelBtn:"取消",submitBtn:"前往",closeCallBack:"TT_pay_dk_1"});return false}}function TT_pay_dk_1(a){if(a==1){callProtocol(1,"","mall/beforPay.htm")}};